---
title: podman使用总结
name: Z.C Yang
date: 2025-09-10 10:00:00 -0500
categories: [容器技术]
tags: [podman]
---


## 容器网络

### 创建网络
```shell
# 创建网络
podman network create es-net

# 查看网络是否创建成功
podman network ls
```

### 运行时连接网络

某些情况下容器已经运行了，但是没有配置好网络，需要使用下述步骤修改网络配置：

```shell
# 语法：podman network connect 网络名称 容器名称
podman network connect es-net elasticsearch7

podman network connect es-net kibana
```

### 查看网络配置

```shell
# 查看网络列表
podman network ls

# 查看网络详情
podman network inspect es-net

# 查看容器网络配置
podman inspect -f '{{.NetworkSettings.Networks}}' kibana
```

## mysql安装

打开podman交互界面方式：
- 在windows teminal中找到podman-machine-default下拉进入
- 在terminal输入wsl相关命令:
```shell
wsl -d podman-machine-default
```

### 拉取mysql镜像

```shell
podman pull mysql:8.0
```

查看本地镜像是否拉取成功:
```shell
podman images
```

### 准备mysql持久化目录

在宿主机上创建目录，用于挂载到 MySQL 容器中，以实现数据的持久化存储，防止容器删除后数据丢失。

```shell
sudo mkdir -p ~/mysql8/{etc/mysql/conf.d,logs,data,mysql-files}
```

检查目录结构，使用ls -R 命令递归查看目录:
```shell
ls -R ~/mysql8
```

### 创建mysql容器

- 执行podman run命令创建容器

```shell
podman run -p 3306:3306 \
		-e MYSQL_ROOT_PASSWORD=root \
		-v /home/user/mysql8/etc/mysql:/etc/mysql:rw \
		-v /home/user/mysql8/data:/var/lib/mysql:rw \
		-v /home/user/mysql8/log:/var/log/mysql:rw \
		-v /home/user/mysql8/mysql-files:/var/lib/mysql-files:rw \
		--name mysql8 \
		docker.io/library/mysql:8
```

- 检查容器运行状态
```shell
podman ps -a
```

### 配置mysql远程连接

- 进行mysql容器
```shell
podman exec -it mysql8 /bin/bash
```

- 登录mysql
```shell
mysql -uroot -p
```

### 执行授权命令

```shell

-- 授权root用户在所有数据库上的所有权限，并允许其从任何主机连接
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;

-- 刷新权限，使更改立即生效
FLUSH PRIVILEGES;
```

## redis安装

### 拉取redis镜像并安装

```shell
docker run -p 6379:6379 -d redis:latest redis-server
```

## mongodb

### 创建目录并调整权限

确保数据目录和日志目录存在并且权限正确。MongoDB 容器内的 mongodb 用户（UID 999 和 GID 999）需要对这些目录有读写权限。

```shell
mkdir -p ~/mongodb/data
mkdir -p ~/mongodb/logs
sudo chown -R 999:999 ~/mongodb/data
sudo chown -R 999:999 ~/mongodb/logs
```

### 创建配置文件`mongod.conf`

创建一个MongoDB配置文件`mongod.conf`, 内容如下：

```yaml
systemLog:
  destination: file
  path: "/var/log/mongodb/mongod.log"
  logAppend: true
storage:
  dbPath: "/data/db"
net:
  bindIp: "0.0.0.0"
  port: 27017
security:
  authorization: "disabled"
```

### 创建podman网络

```bash
podman network create mongodb-net
```

### 运行MongoDB容器

```bash
podman run -d \
  --name mongodb \
  -v ~/mongodb/data:/data/db \
  -v ~/mongodb/logs:/var/log/mongodb \
  -v ~/mongodb/mongod.conf:/etc/mongod.conf \
  --network mongodb-net \
  docker.io/library/mongo:latest \
  -f /etc/mongod.conf
```

- -d：后台运行容器
- -v ~/mongodb/mongod.conf:/etc/mongod.conf：将主机上的配置文件挂载到容器内的 /etc/mongod.conf 目录，确保 MongoDB 使用指定的配置文件
- --network dco-net：将容器连接到自定义的 mongodb-net 网络
- docker.io/library/mongo:latest：使用的 Docker 镜像名称，从官方 Docker Hub 拉取
- -f /etc/mongod.conf：指定使用 /etc/mongod.conf 配置文件


### 创建MongoDB用户权限

- 进入 MongoDB 容器并启动 MongoDB Shell

```shell
podman exec -it mongodb /bin/bash
mongo
```

- 创建admin用户和权限

在MongoDB shell中，创建`admin`数据库的用户并分配权限，例如：
```shell
use admin
db.createUser({
  user: "admin",
  pwd: "admin123",
  roles: [{ role: "root", db: "admin" }]
})
exit
exit
```

- 创建atomdco数据库的用户并分配权限，例如：
```shell
podman exec -it mongodb /bin/bash

mongo -u admin -p admin123 --authenticationDatabase admin
use atomdco
db.createUser({
  user: "test1",
  pwd: "111111",
  roles: [{role: "readWrite", db: "atomdco"}]
})
exit
exit
```

### 启用MongoDB认证

- 停止并删除MongoDB容器
```bash
podman stop mongodb
podman rm mongodb
```

- 修改配置文件`mongod.conf` 以启用认证

编辑`mongod.conf`文件，启用`authorization`:

```yaml
systemLog:
  destination: file
  path: "/var/log/mongodb/mongod.log"
  logAppend: true
storage:
  dbPath: "/data/db"
net:
  bindIp: "0.0.0.0"
  port: 27017
security:
  authorization: "enabled"
```

- 重新运行MongoDB容器
```shell
podman run -d \
  --name mongodb \
  -p 27017:27017 \
  -v ~/mongodb/data:/data/db \
  -v ~/mongodb/logs:/var/log/mongodb \
  -v ~/mongodb/mongod.conf:/etc/mongod.conf \
  --network mongodb-net \
  docker.io/library/mongo:latest \
  -f /etc/mongod.conf
```

### 验证 MongoDB容器是否正确运行

- 查看容器状态

```shell
podman ps -a
```

- 查看日志文件

```shell
podman logs mongodb
```
或者实时查看日志文件：

```shell
podman logs -f mongodb
```

- 验证端口监听
```shell
podman exec -it mongodb /bin/bash
```

### 应用所在的容器如何连接到mongodb容器
假设有一godco的应用，有配置文件etc/godco-api.yaml,演示下该应用，如何使用上述创建好的mongodb数据库。

修改 `etc/godco-api.yaml` 中的 MongoDB 连接字符串:

由于 godco 容器和 mongodb 容器在同一个自定义网络中，可以使用 mongodb 作为主机名。修改 etc/godco-api.yaml 文件中的 MongoDB 连接字符串如下：

```yaml
MonDB:
  Url: "mongodb://test1:111111@mongodb:27017/?tls=false&authSource=atomdco"
  DbName: "atomdco"

```

在这个配置中：

mongodb 是 MongoDB 容器的名称。
test1 是 MongoDB 用户名。
111111 是 MongoDB 密码。
authSource=atomdco 指定认证数据库为 atomdco。


### 运行`godco`容器并连接到自定义网络
运行`godco`容器，并连接到自定义网络：

```shell
podman run -d \
  -p 8080:8080 \
  -v /path/to/your/etc:/app/etc \
  -v /path/to/your/static:/app/static \
  --network mongodb-net \
  --name dco-verification-app \
  godco:latest

```

### 验证`godco`容器是否成功连接到 MongoDB

查看 godco 容器的日志文件，以确认它是否成功连接到 MongoDB 容器:

```shell
podman logs dco-verification-app
```

或者实时查看日志文件：

```shell
podman logs -f dco-verification-app
```

### 使用`mongosh`连接到`MongoDB`并提供认证信息

```shell
mongosh "mongodb://username:password@localhost:27017/?authSource=atomdco"
```

- 获取 MongoDB 容器的 IP 地址
```shell
mongosh "mongodb://username:password@localhost:27017/?authSource=atomdco"
```

没有启用端口映射的情况下，需要以下方式连接：

```shell
podman inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mongodb
```

- 连接到 MongoDB 并提供认证信息

```shell
mongosh "mongodb://test1:111111@10.89.0.5:27017/?authSource=atomdco"
```

验证数据库

```shell
show databases
```

### 参考链接

[使用 Docker(Podman) 部署 MongoDB 数据库及使用详](https://blog.csdn.net/yyz_1987/article/details/145415178)


## podman-compose

### 检查python环境

```shell
 python --version
```

linux系统默认可能存在python但是不存在pip，进行pip安装：

```shell
# redhat系
sudo yum install python3-pip

# debian系
sudo apt-get install python3-pip
```

### 安装podman-compose

```shell
pip install --upgrade pip
pip install podman-compose

# 查看版本
podman-compose -v
```

docker-compose.yml示例：

```yaml
version: '3'
services:
  nginx:
    image: nginx:1.27
    container_name: nginx
    restart: always
    ports:
      - 8080:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
      - ./nginx/html:/usr/share/nginx/html
```

在yaml所在目录执行：

```shell
podman-compose up -d nginx
```

### 使用原有docker命令(可选)

- 写到`~/.zshrc`或`~/.bashrc`

```bash
alias docker podman
```

```bash
source ~/.zshrc
```

- 软链接

```bash
ln -s $(which podman) /usr/local/bin/docker
```

- 继续使用docker命令

```bash
docker ps
```


## elasticsearch安装

### 桥接网络的创建
```shell
# 创建网络
podman network create es-net  --dns 8.8.8.8

# 查看网络是否创建成功
podman network ls
```

### 安装

本地开发调试的版本为v7，podman主要安装命令为:
```shell
# 拉取镜像
podman pull elasticsearch:7.12.0

# 运行
podman run -d --name elasticsearch7 --network es-net -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.io/library/elasticsearch:7.12.0
```

### 安装`ik_max_word`分词器

进入容器:
```shell
podman exec -it elasticsearch7 /bin/bash
```

在线下载并安装:
```shell
./bin/elasticsearch-plugin install https://get.infini.cloud/elasticsearch/analysis-ik/7.12.0
```

## kibana安装

kibana可以理解为ES的可视化管理工具，版本需要和ES相同，结合上述用到的`elasticsearch:7.12.0`版本，podman主要安装命令为:
```shell
# 拉取镜像
podman pull kibana:7.12.0

# 运行
podman run --name kibana --network es-net -e ELASTICSEARCH_HOSTS=http://127.0.0.1:9200 -p 5601:5601 -d kibana:7.12.0
```

映射配置文件的情况下运行:
```shell
podman run --name kibana --network es-net -p 5601:5601 -v ./kibana.yml:/usr/share/kibana/config/kibana.yml -d kibana:7.12.0 
```

kibana.yml的配置为:
```yml
server.name: kibana
server.host: "0.0.0.0"
elasticsearch.hosts: [ "http://127.0.0.1:9200" ]
monitoring.ui.container.elasticsearch.enabled: true
```

## php7.4环境搭建


### 创建自定义网络

```shell
# 创建网络
podman network create php-net --dns 8.8.8.8
```

### nginx安装

- 拉取镜像

```shell
podman pull nginx       
```

- 配置

```shell
# 创建nginx www映射目录, 本机pwd之后的全称为： /home/user/nginx/www
midir -p ~/nginx/www 
```

nginx配置映射文件：
```bash

server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;
    root /home/user/nginx/www/yang/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /home/user/nginx/www/yang/public;
    }

    location ~ \.php$ {
        root /home/user/nginx/www/yang/public;
        fastcgi_pass   172.20.29.91:9000;    //容器的ip地址
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;
    }
}
```

- 运行

```bash
podman run -p 8080:80 -d --name nginx --network php-net -v /home/user/nginx/default.conf:/etc/nginx/conf.d/default.conf -v /home/user/nginx/www:/home/user/nginx/www  --privileged=true nginx
```

### php7.4安装

- 拉取镜像

```bash
podman pull php:7.4-fpm
```

- 使用php镜像开启php-frm应用容器

```bash
podman run -p 9000:9000 -d --name php --network php-net \
-v /home/user/nginx/www:/home/user/nginx/www \
-v /home/user/php/etc:/usr/local/etc \
-v /home/user/php/log:/usr/log/php \
--privileged=true php:7.4-fpm
```

- 复制配置文件到映射目录
```bash
podman cp php:/usr/local/etc /home/user/php/etc
```


### 安装对应扩展

进入php容器:

```bash
podman exec -it php /bin/bash
```


#### 安装pdo-mysql扩展

```bash

# 切换到映射的php conf目录
cd /home/user/php/etc/php/conf.d
# 新建`docker-php-ext-pdo_mysql.ini`文件
touch docker-php-ext-pdo_mysql.ini
# 文件内容
extension=pdo_mysql.so

# 指定安装命令
docker-php-ext-install pdo_mysql

# 通过命令确认
php -m 
# 或者
php -r "phpinfo();" | grep pdo_mysql

```

### 安装redis扩展

```bash
# 切换到映射的php conf目录
cd /home/user/php/etc/php/conf.d
# 新建`docker-php-ext-redis.ini`文件
touch docker-php-ext-redis.ini
# 文件内容
extension=redis.so

# 安装redis
pecl install -n redis-5.3.4

docker-php-ext-enable redis

```

### 配置network后发现外网域名无法解析问题

```bash
# 进入容器
podman exec -it php bash

# 编辑 resolv.conf
echo "nameserver 8.8.8.8" > /etc/resolv.conf
```


## 参考文章
[podman windows安装指南](https://github.com/containers/podman/blob/main/docs/tutorials/podman-for-windows.md)
[使用podman创建Mysql镜像容器](https://www.cnblogs.com/mhzch/p/19026819)
[docker在自定义网络中安装ElasticSearch和Kibana的步骤](https://www.jb51.net/server/348222bev.htm)
